<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estadísticas de Visitas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Estadísticas de Visitas</h1>

    <label for="datePicker">Selecciona una fecha:</label>
    <input type="date" id="datePicker">
    <button onclick="updateCharts()">Actualizar</button>

    <canvas id="visitsByPageChart" width="400" height="200"></canvas>
    <canvas id="visitsOverTimeChart" width="400" height="200"></canvas>

    <script>
        let visitsData = [];

        async function fetchVisitData() {
            const response = await fetch('https://xinocore.com/?stats=true');
            const data = await response.json();
            visitsData = data.visits;  // Guardamos todos los datos
        }

        function filterVisitsByDate(date) {
            return visitsData.filter(visit => visit.time.startsWith(date));
        }

        function renderCharts(filteredVisits) {
            // Procesar visitas por página
            const pageCounts = {};
            const visitsOverTime = {};

            filteredVisits.forEach(visit => {
                if (pageCounts[visit.page]) {
                    pageCounts[visit.page]++;
                } else {
                    pageCounts[visit.page] = 1;
                }

                const timeKey = visit.time.split("T")[1].substring(0, 5); // HH:MM
                if (visitsOverTime[timeKey]) {
                    visitsOverTime[timeKey]++;
                } else {
                    visitsOverTime[timeKey] = 1;
                }
            });

            // Datos para gráfico de visitas por página
            const pageLabels = Object.keys(pageCounts);
            const pageData = Object.values(pageCounts);

            const ctx1 = document.getElementById('visitsByPageChart').getContext('2d');
            if (window.pageChart) window.pageChart.destroy();
            window.pageChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: pageLabels,
                    datasets: [{
                        label: 'Visitas por página',
                        data: pageData,
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true } }
                }
            });

            // Datos para gráfico de visitas en el tiempo
            const timeLabels = Object.keys(visitsOverTime).sort();
            const timeData = timeLabels.map(time => visitsOverTime[time]);

            const ctx2 = document.getElementById('visitsOverTimeChart').getContext('2d');
            if (window.timeChart) window.timeChart.destroy();
            window.timeChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: timeLabels,
                    datasets: [{
                        label: 'Visitas en el tiempo',
                        data: timeData,
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        x: { type: 'category' },
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        async function updateCharts() {
            const selectedDate = document.getElementById('datePicker').value;
            if (!selectedDate) return;
            const filteredVisits = filterVisitsByDate(selectedDate);
            renderCharts(filteredVisits);
        }

        async function init() {
            await fetchVisitData();
            const today = new Date().toISOString().split("T")[0];
            document.getElementById('datePicker').value = today;
            updateCharts();
        }

        init();
    </script>
</body>
</html>

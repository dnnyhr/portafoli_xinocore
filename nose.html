<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Estadísticas de Visitas</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Estadísticas de Visitas</h1>

    <label for="datePicker">Selecciona una fecha:</label>
    <input type="date" id="datePicker">
    <button onclick="updateCharts()">Actualizar</button>

    <h2>Ranking de Páginas más Visitadas</h2>
    <table border="1">
        <thead>
            <tr>
                <th>Posición</th>
                <th>Página</th>
                <th>Visitas</th>
                <th>Porcentaje</th>
            </tr>
        </thead>
        <tbody id="rankingTable"></tbody>
    </table>

    <canvas id="visitsByPageChart"></canvas>
    <canvas id="visitsOverTimeChart"></canvas>

    <script>
        let visitsData = [];

        async function fetchVisitData() {
            try {
                const response = await fetch('https://xinocore.com/?stats=true');
                const data = await response.json();
                visitsData = data.visits || [];
            } catch (error) {
                console.error("Error al obtener los datos:", error);
                visitsData = [];
            }
        }

        function filterVisitsByDate(date) {
            return visitsData.filter(visit => visit.time.startsWith(date));
        }

        function renderRanking(filteredVisits) {
            const pageCounts = {};
            filteredVisits.forEach(visit => {
                pageCounts[visit.page] = (pageCounts[visit.page] || 0) + 1;
            });

            const totalVisits = filteredVisits.length || 1;
            const sortedPages = Object.entries(pageCounts)
                .sort((a, b) => b[1] - a[1])
                .map(([page, count], index) => ({
                    position: index + 1,
                    page,
                    count,
                    percentage: ((count / totalVisits) * 100).toFixed(2) + "%"
                }));

            const rankingTable = document.getElementById("rankingTable");
            rankingTable.innerHTML = sortedPages.map(({ position, page, count, percentage }) => `
                <tr>
                    <td>${position}</td>
                    <td>${page}</td>
                    <td>${count}</td>
                    <td>${percentage}</td>
                </tr>
            `).join("");
        }

        function renderCharts(filteredVisits) {
            const pageCounts = {};
            const visitsOverTime = {};

            filteredVisits.forEach(visit => {
                pageCounts[visit.page] = (pageCounts[visit.page] || 0) + 1;
                const timeKey = visit.time.split("T")[1].substring(0, 5);
                visitsOverTime[timeKey] = (visitsOverTime[timeKey] || 0) + 1;
            });

            const ctx1 = document.getElementById('visitsByPageChart').getContext('2d');
            if (window.pageChart) window.pageChart.destroy();
            window.pageChart = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(pageCounts),
                    datasets: [{
                        label: 'Visitas por página',
                        data: Object.values(pageCounts),
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });

            const ctx2 = document.getElementById('visitsOverTimeChart').getContext('2d');
            if (window.timeChart) window.timeChart.destroy();
            window.timeChart = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: Object.keys(visitsOverTime).sort(),
                    datasets: [{
                        label: 'Visitas en el tiempo',
                        data: Object.values(visitsOverTime),
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { x: { type: 'category' }, y: { beginAtZero: true } } }
            });
        }

        async function updateCharts() {
            const selectedDate = document.getElementById('datePicker').value;
            if (!selectedDate) return alert("Selecciona una fecha válida.");
            const filteredVisits = filterVisitsByDate(selectedDate);
            renderRanking(filteredVisits);
            renderCharts(filteredVisits);
        }

        async function init() {
            await fetchVisitData();
            await fetchVisitData();
            const today = new Date().toISOString().split("T")[0];
            await updateCharts();
            updateCharts();
        }

        init();
    </script>
</body>
</html>
